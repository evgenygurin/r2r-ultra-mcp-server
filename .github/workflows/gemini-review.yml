name: Gemini Documentation Review

on:
  pull_request:
    branches: [main, develop]
    paths:
      - 'docs/**/*.md'
      - '.claude/**/*.md'
      - 'CLAUDE.md'
      - 'README.md'

jobs:
  review-docs:
    name: Review Documentation Changes
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout PR
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Get changed markdown files
        id: changed-files
        run: |
          # Get list of changed .md files
          git diff --name-only origin/${{ github.base_ref }}...HEAD | grep '\.md$' > changed_files.txt || true
          
          if [ -s changed_files.txt ]; then
            echo "üìù Changed documentation files: $(wc -l < changed_files.txt)"
            cat changed_files.txt
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "No markdown files changed"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Setup Python
        if: steps.changed-files.outputs.has_changes == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        if: steps.changed-files.outputs.has_changes == 'true'
        run: |
          pip install google-generativeai requests
      
      - name: Review documentation with Gemini
        if: steps.changed-files.outputs.has_changes == 'true'
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          python3 << 'EOF'
          import os
          import sys
          import google.generativeai as genai
          
          api_key = os.environ.get('GEMINI_API_KEY')
          if not api_key:
              print("‚ùå GEMINI_API_KEY secret not configured")
              sys.exit(1)
          
          # Configure Gemini API (AI Studio, not Vertex AI)
          genai.configure(api_key=api_key)
          model = genai.GenerativeModel('gemini-1.5-flash')
          
          # Read project context from CLAUDE.md
          project_context = ""
          try:
              with open('CLAUDE.md', 'r', encoding='utf-8') as f:
                  # Read key sections for context
                  content = f.read()
                  # Extract project overview and key guidelines
                  if '## üéØ –û–±–∑–æ—Ä –ø—Ä–æ–µ–∫—Ç–∞' in content:
                      start = content.find('## üéØ –û–±–∑–æ—Ä –ø—Ä–æ–µ–∫—Ç–∞')
                      end = content.find('## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞')
                      if end > start:
                          project_context = content[start:end]
                  
                  # Add style guidelines
                  if '## ‚úÖ –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–∞–∫—Ç–∏–∫–∏' in content:
                      start = content.find('## ‚úÖ –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–∞–∫—Ç–∏–∫–∏')
                      end = content.find('##', start + 10)
                      if end > start:
                          project_context += "\n\n" + content[start:end if end != -1 else len(content)]
          except Exception as e:
              print(f"‚ö†Ô∏è  Could not read CLAUDE.md: {e}")
          
          # Read changed files
          with open('changed_files.txt', 'r') as f:
              changed_files = [line.strip() for line in f if line.strip()]
          
          if not changed_files:
              print("‚úÖ No documentation files to review")
              sys.exit(0)
          
          print(f"üìù Reviewing {len(changed_files)} files...")
          
          # Prepare comprehensive review for each file
          reviews = []
          all_contents = {}  # Store all file contents for cross-reference check
          
          # First pass: read all files
          for filepath in changed_files:
              try:
                  with open(filepath, 'r', encoding='utf-8') as f:
                      all_contents[filepath] = f.read()
              except Exception as e:
                  print(f"‚ùå Error reading {filepath}: {e}")
          
          # Second pass: review each file with full context
          for filepath, content in all_contents.items():
              try:
                  # Determine file category for context-specific checks
                  file_category = "general"
                  if "/r2r/" in filepath:
                      file_category = "R2R v3 documentation"
                  elif "/fastmcp/" in filepath:
                      file_category = "FastMCP 2.x documentation"
                  elif "/claude_code/" in filepath:
                      file_category = "Claude Code 1.0.58+ documentation"
                  elif "/.claude/" in filepath:
                      file_category = "R2R integration (commands/skills/agents)"
                  
                  prompt = f"""–í—ã - —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π —Ä–µ—Ü–µ–Ω–∑–µ–Ω—Ç —Ä—É—Å—Å–∫–æ—è–∑—ã—á–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –¥–ª—è AI-–ø—Ä–æ–µ–∫—Ç–æ–≤.

–ö–û–ù–¢–ï–ö–°–¢ –ü–†–û–ï–ö–¢–ê:
{project_context}

–í–ê–ñ–ù–û: –≠—Ç–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è-only —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π. –ù–∏–∫–∞–∫–æ–≥–æ –∫–æ–¥–∞ –¥–ª—è –∫–æ–º–ø–∏–ª—è—Ü–∏–∏/—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.

–§–∞–π–ª: {filepath}
–ö–∞—Ç–µ–≥–æ—Ä–∏—è: {file_category}

–ü–†–û–í–ï–†–¨–¢–ï –î–û–ö–£–ú–ï–ù–¢–ê–¶–ò–Æ –ù–ê:

1. **–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å**:
   - –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å API endpoints –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
   - –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –≤–µ—Ä—Å–∏—è–º (R2R v3, FastMCP 2.x, Claude Code 1.0.58+)
   - –ê–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å –ø—Ä–∏–º–µ—Ä–æ–≤ –∫–æ–¥–∞ (—Ä–∞–±–æ—Ç–∞—é—Ç –ª–∏ –æ–Ω–∏?)
   - –ü—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö —Ç–µ—Ä–º–∏–Ω–æ–≤

2. **–ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å —Ç–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏–∏**:
   - –†—É—Å—Å–∫–∏–π —Ç–µ–∫—Å—Ç + –∞–Ω–≥–ª–∏–π—Å–∫–∏–µ —Ç–µ—Ä–º–∏–Ω—ã (RAG, agent, collection, etc)
   - –ï–¥–∏–Ω–æ–æ–±—Ä–∞–∑–∏–µ –Ω–∞–∑–≤–∞–Ω–∏–π (–Ω–µ "–∫–æ–ª–ª–µ–∫—Ü–∏—è" –∏ "collection" –≤–ø–µ—Ä–µ–º–µ—à–∫—É)
   - –°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å —Å –¥—Ä—É–≥–∏–º–∏ —Ä–∞–∑–¥–µ–ª–∞–º–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏

3. **–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**:
   - –≠–º–æ–¥–∑–∏ –≤ –∑–∞–≥–æ–ª–æ–≤–∫–∞—Ö H2 (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ: üéØ, üìÅ, üîç, ‚öôÔ∏è, üìö, üîó, ‚ö†Ô∏è, ‚úÖ, ‚ùå)
   - –ù—É–º–µ—Ä–∞—Ü–∏—è —Ñ–∞–π–ª–æ–≤: NN-section-name.md (01, 02, 03...)
   - –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö —Å—Å—ã–ª–æ–∫ (–æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–µ –ø—É—Ç–∏)
   - –ù–∞–ª–∏—á–∏–µ –ø—Ä–∏–º–µ—Ä–æ–≤ –∫–æ–¥–∞ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º

4. **–ü–æ–ª–Ω–æ—Ç–∞ –∏ —è—Å–Ω–æ—Å—Ç—å**:
   - –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ª–∏ –ø—Ä–∏–º–µ—Ä–æ–≤?
   - –ü–æ–Ω—è—Ç–Ω—ã –ª–∏ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è?
   - –ï—Å—Ç—å –ª–∏ –≤–∞–∂–Ω—ã–µ –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã–µ —Ç–µ–º—ã?
   - –ù—É–∂–Ω—ã –ª–∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ—è—Å–Ω–µ–Ω–∏—è?

5. **–ì—Ä–∞–º–º–∞—Ç–∏–∫–∞ –∏ —Å—Ç–∏–ª—å**:
   - –û—Ä—Ñ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–µ –∏ –≥—Ä–∞–º–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏
   - –ß–∏—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—å —Ç–µ–∫—Å—Ç–∞
   - –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ç–æ–Ω

6. **–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ CLAUDE.md**:
   - –°–ª–µ–¥—É–µ—Ç –ª–∏ —Ñ–∞–π–ª —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–º –∫–æ–Ω–≤–µ–Ω—Ü–∏—è–º?
   - –ù–µ—Ç –ª–∏ –∑–∞–ø—Ä–µ—â–µ–Ω–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π (build scripts, package.json, etc)?
   - –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –ª–∏ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã (rg –≤–º–µ—Å—Ç–æ grep)?

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê:

### ‚úÖ –ß—Ç–æ —Ö–æ—Ä–æ—à–æ
[2-3 –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã—Ö –º–æ–º–µ–Ω—Ç–∞]

### ‚ö†Ô∏è  –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è (–Ω–µ –∫—Ä–∏—Ç–∏—á–Ω—ã–µ, –Ω–æ —Å—Ç–æ–∏—Ç —É–ª—É—á—à–∏—Ç—å)
[–°–ø–∏—Å–æ–∫ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π —Å —É–∫–∞–∑–∞–Ω–∏–µ–º —Å—Ç—Ä–æ–∫/—Ä–∞–∑–¥–µ–ª–æ–≤]

### ‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏ (—Ç—Ä–µ–±—É—é—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–≥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è)
[–°–ø–∏—Å–æ–∫ –æ—à–∏–±–æ–∫ —Å —É–∫–∞–∑–∞–Ω–∏–µ–º —Å—Ç—Ä–æ–∫ –∏ –∫–∞–∫ –∏—Å–ø—Ä–∞–≤–∏—Ç—å]

### üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é
[2-3 –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è]

### üìä –û—Ü–µ–Ω–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞: X/10
[–ö—Ä–∞—Ç–∫–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ –æ—Ü–µ–Ω–∫–∏]

–ë—É–¥—å—Ç–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã: —É–∫–∞–∑—ã–≤–∞–π—Ç–µ –Ω–æ–º–µ—Ä–∞ —Å—Ç—Ä–æ–∫, –ø—Ä–∏–º–µ—Ä—ã –æ—à–∏–±–æ–∫, –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è.
–ï—Å–ª–∏ –≤—Å–µ –æ—Ç–ª–∏—á–Ω–æ - —Ç–∞–∫ –∏ –Ω–∞–ø–∏—à–∏—Ç–µ.

---
–°–û–î–ï–†–ñ–ò–ú–û–ï –§–ê–ô–õ–ê:
{content}
"""
                  
                  response = model.generate_content(prompt)
                  reviews.append(f"## üìÑ {filepath}\n\n{response.text}\n\n---\n")
                  
              except Exception as e:
                  reviews.append(f"## üìÑ {filepath}\n\n‚ùå **–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ**: {str(e)}\n\n---\n")
          
          # Third pass: check consistency across files (if multiple docs files changed)
          if len(changed_files) > 1:
              try:
                  docs_files = [f for f in changed_files if f.startswith('docs/')]
                  if len(docs_files) > 1:
                      combined_content = "\n\n".join([
                          f"=== {filepath} ===\n{all_contents[filepath][:2000]}"
                          for filepath in docs_files[:3]  # Limit to 3 files for context window
                      ])
                      
                      consistency_prompt = f"""–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ö–û–ù–°–ò–°–¢–ï–ù–¢–ù–û–°–¢–¨ –º–µ–∂–¥—É —Ñ–∞–π–ª–∞–º–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏:

{combined_content}

–ü–†–û–í–ï–†–¨–¢–ï:
1. –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –ª–∏ –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ —Ç–µ—Ä–º–∏–Ω—ã –¥–ª—è –æ–¥–Ω–∏—Ö –∏ —Ç–µ—Ö –∂–µ –∫–æ–Ω—Ü–µ–ø—Ü–∏–π?
2. –ù–µ—Ç –ª–∏ –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–π –≤ –æ–ø–∏—Å–∞–Ω–∏–∏ API –∏–ª–∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏?
3. –°–æ–≥–ª–∞—Å–æ–≤–∞–Ω—ã –ª–∏ –ø—Ä–∏–º–µ—Ä—ã –∫–æ–¥–∞?
4. –ï–¥–∏–Ω–æ–æ–±—Ä–∞–∑–µ–Ω –ª–∏ —Å—Ç–∏–ª—å –∏–∑–ª–æ–∂–µ–Ω–∏—è?

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê:
- ‚úÖ –ï—Å–ª–∏ –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å —Å–æ–±–ª—é–¥–µ–Ω–∞
- ‚ö†Ô∏è  –ù–∞–π–¥–µ–Ω–Ω—ã–µ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ –ø—Ä–∏–º–µ—Ä–∞–º–∏
- üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏
"""
                      
                      consistency_response = model.generate_content(consistency_prompt)
                      reviews.insert(0, f"## üîó –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏ –º–µ–∂–¥—É —Ñ–∞–π–ª–∞–º–∏\n\n{consistency_response.text}\n\n---\n")
              except Exception as e:
                  print(f"‚ö†Ô∏è  Could not perform consistency check: {e}")
          
          # Write review to file
          with open('review_output.md', 'w', encoding='utf-8') as f:
              f.write("# ü§ñ Gemini Documentation Review\n\n")
              f.write(f"**–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ —Ñ–∞–π–ª–æ–≤:** {len(changed_files)}\n\n")
              f.write("**–ö–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–æ–µ–∫—Ç–∞:** –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è-only —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –¥–ª—è R2R v3, FastMCP 2.x, Claude Code 1.0.58+\n\n")
              f.write("---\n\n")
              f.write('\n'.join(reviews))
              f.write("\n---\n\n")
              f.write("*–≠—Ç–æ—Ç –æ–±–∑–æ—Ä —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏. –§–∏–Ω–∞–ª—å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ –∑–∞ —á–µ–ª–æ–≤–µ–∫–æ–º-—Ä–µ—Ü–µ–Ω–∑–µ–Ω—Ç–æ–º.*\n")
          
          # Print summary
          print("\nüìä Review Summary:")
          with open('review_output.md', 'r', encoding='utf-8') as f:
              print(f.read())
          EOF
      
      - name: Post review as comment
        if: steps.changed-files.outputs.has_changes == 'true' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            if (!fs.existsSync('review_output.md')) {
              console.log('No review output found');
              return;
            }
            
            const review = fs.readFileSync('review_output.md', 'utf8');
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: review
            });
