name: CI - Documentation

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  validate-docs:
    name: Validate Documentation
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check markdown files exist
        run: |
          echo "Checking documentation structure..."
          test -d docs/r2r && echo "‚úÖ R2R docs found"
          test -d docs/fastmcp && echo "‚úÖ FastMCP docs found"
          test -d docs/claude_code && echo "‚úÖ Claude Code docs found"

      - name: Count markdown files
        run: |
          echo "R2R documentation files:"
          find docs/r2r -name "*.md" | wc -l
          echo "FastMCP documentation files:"
          find docs/fastmcp -name "*.md" | wc -l
          echo "Claude Code documentation files:"
          find docs/claude_code -name "*.md" | wc -l

      - name: Verify README files
        run: |
          test -f docs/r2r/README.md || exit 1
          test -f docs/fastmcp/README.md || exit 1
          test -f docs/claude_code/README.md || exit 1
          echo "‚úÖ All README.md files present"

      - name: Check for broken internal links
        run: |
          echo "Checking for common broken link patterns..."
          if grep -r "](/" docs/ --include="*.md" | grep -v "http" | grep -v "mailto"; then
            echo "‚ö†Ô∏è  Warning: Found absolute paths in links (should be relative)"
          else
            echo "‚úÖ No absolute path links found"
          fi

  validate-scripts:
    name: Validate R2R Scripts
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check R2R CLI structure
        run: |
          test -f .claude/scripts/r2r || exit 1
          test -f .claude/scripts/lib/common.sh || exit 1
          test -d .claude/scripts/commands || exit 1
          echo "‚úÖ R2R CLI structure valid"

      - name: Verify bash scripts syntax
        run: |
          echo "Checking bash scripts syntax..."
          for script in .claude/scripts/*.sh .claude/scripts/commands/*.sh; do
            if [ -f "$script" ]; then
              bash -n "$script" && echo "‚úÖ $script" || exit 1
            fi
          done

      - name: Check for .env template
        run: |
          if [ ! -f .claude/config/.env ]; then
            echo "‚ö†Ô∏è  Warning: .claude/config/.env not found (expected for security)"
            echo "‚úÖ This is correct - .env should not be committed"
          else
            echo "‚ùå .env file should not be committed to repository"
            exit 1
          fi

  check-formatting:
    name: Check Documentation Formatting
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check file naming convention
        run: |
          echo "Checking file naming conventions..."
          # Check that documentation files follow NN-name.md pattern
          for dir in docs/r2r docs/fastmcp docs/claude_code; do
            echo "Checking $dir..."
            ls "$dir"/*.md | grep -E '0[0-9]-.*\.md|README\.md|SUMMARY\.md' || true
          done

      - name: Verify no package.json exists
        run: |
          if [ -f package.json ]; then
            echo "‚ùå package.json found - this is a documentation repository"
            exit 1
          else
            echo "‚úÖ No package.json (correct for docs repository)"
          fi

      - name: Verify no requirements.txt exists
        run: |
          if [ -f requirements.txt ]; then
            echo "‚ùå requirements.txt found - this is a documentation repository"
            exit 1
          else
            echo "‚úÖ No requirements.txt (correct for docs repository)"
          fi

  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [validate-docs, validate-scripts, check-formatting]
    if: always()

    steps:
      - name: Check results
        run: |
          echo "üìä CI Summary"
          echo "Documentation validation: ${{ needs.validate-docs.result }}"
          echo "Scripts validation: ${{ needs.validate-scripts.result }}"
          echo "Formatting check: ${{ needs.check-formatting.result }}"
          
          if [ "${{ needs.validate-docs.result }}" = "success" ] && \
             [ "${{ needs.validate-scripts.result }}" = "success" ] && \
             [ "${{ needs.check-formatting.result }}" = "success" ]; then
            echo "‚úÖ All checks passed"
            exit 0
          else
            echo "‚ùå Some checks failed"
            exit 1
          fi
