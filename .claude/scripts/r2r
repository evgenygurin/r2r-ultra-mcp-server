#!/usr/bin/env bash
# R2R CLI - Main entry point
# Routes commands to modular scripts

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"

# Show help
show_help() {
    cat << EOF
R2R CLI - Modular Command Interface

USAGE:
    r2r <command> [options] <arguments>

CORE COMMANDS:
    search <query> [limit]              Search knowledge base (hybrid search)
    rag <query> [max_tokens]            RAG query with generation
    agent <query> [mode] [conv_id]     Agent conversation with tools

MANAGEMENT COMMANDS:
    docs <action> [args]                Document management (list, get, upload, delete)
    collections <action> [args]         Collection management (list, create, add-doc)
    graph <action> [args]               Knowledge graph operations (entities, relationships)
    analytics <action> [args]           Analytics (collection, document, system)

GLOBAL FLAGS:
    --json                              Output raw JSON response
    --verbose                           Show detailed metadata (search only)
    --thinking                          Enable extended thinking (agent only)

EXAMPLES:
    # Core - Search
    r2r search "machine learning" 5
    r2r search "AI" --filter document_type=pdf
    r2r search "transformers" --graph --collection abc123

    # Core - RAG & Agent
    r2r rag "Explain transformers"
    r2r agent "What is DeepSeek R1?"

    # Management
    r2r docs list
    r2r collections create "My Collection"
    r2r graph entities abc123
    r2r analytics collection abc123

For detailed help on each command:
    r2r <command> help

    Examples:
    r2r docs help
    r2r collections help
    r2r graph help
EOF
}

# Main command dispatcher
COMMAND="${1:-help}"

case "$COMMAND" in
    search)
        shift
        "${SCRIPT_DIR}/commands/search.sh" "$@"
        ;;

    rag)
        shift
        "${SCRIPT_DIR}/commands/rag.sh" "$@"
        ;;

    agent)
        shift
        "${SCRIPT_DIR}/commands/agent.sh" "$@"
        ;;

    docs|documents)
        shift
        "${SCRIPT_DIR}/commands/docs.sh" "$@"
        ;;

    collections|coll)
        shift
        "${SCRIPT_DIR}/commands/collections.sh" "$@"
        ;;

    graph|kg)
        shift
        "${SCRIPT_DIR}/commands/graph.sh" "$@"
        ;;

    analytics|stats)
        shift
        "${SCRIPT_DIR}/commands/analytics.sh" "$@"
        ;;

    help|--help|-h)
        show_help
        ;;

    *)
        echo "Error: Unknown command '$COMMAND'" >&2
        echo "Run 'r2r help' for usage information" >&2
        exit 1
        ;;
esac
