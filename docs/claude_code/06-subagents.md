# 06: Субагенты (Subagents)

## Обзор

Субагенты (Subagents) в Claude Code — это специализированные AI-агенты, которые выполняют конкретные задачи в рамках общего рабочего процесса. Они позволяют разделять сложные задачи на управляемые части и выполнять их параллельно или последовательно, повышая эффективность и качество работы.

## Ключевые концепции

### Что такое субагенты?

Субагенты — это независимые экземпляры Claude, которые:
- Выполняют специфические подзадачи
- Имеют собственные инструкции и контекст
- Могут работать параллельно для ускорения выполнения
- Возвращают результаты основному агенту
- Имеют доступ к MCP-инструментам
- Могут указывать запрещенные инструменты через `disallowedTools`

### Когда используются субагенты?

Claude автоматически запускает субагентов для:
- **Исследования кодовой базы** — поиск паттернов и архитектурных решений
- **Параллельного анализа** — одновременная проверка разных аспектов кода
- **Планирования сложных задач** — декомпозиция больших фич
- **Специализированных проверок** — code review, тестирование, документация

## Типы субагентов

### 1. Explore (Исследование)

**Назначение:** Быстрое исследование кодовой базы

**Возможности:**
- Работает на модели Haiku 4.5 для скорости
- Автоматически активируется для открытых поисковых запросов
- Эффективно ищет паттерны кода
- Экономит токены контекста
- Отвечает на вопросы о структуре и реализации

**Примеры использования:**
```bash
# Автоматически запускается при:
"Где обрабатываются ошибки?"
"Покажи все компоненты авторизации"
"Найди реализацию API endpoints"
```

### 2. Plan (Планирование)

**Назначение:** Разработка стратегии для сложных многоэтапных задач

**Процесс работы:**
1. Анализ сложности задачи
2. Создание стратегии реализации
3. Разбиение на фазы
4. Координация выполнения

**Оптимизация моделей:**
- Haiku 4.5 использует Sonnet для планирования
- Переключается на Haiku для выполнения
- Баланс между качеством и стоимостью

**Управление:**
```bash
# Переключение режима мышления (Tab key)
# Временное отключение: /t в промпте
# Визуализация процесса планирования
```

### 3. Code Explorer (Исследователь кода)

**Назначение:** Глубокий анализ существующего кода

**Задачи:**
- Идентификация ключевых файлов для чтения
- Анализ архитектурных паттернов
- Поиск зависимостей и интеграций
- Понимание структуры проекта

**Рекомендации:**
```markdown
После завершения работы агента:
1. Прочитайте все файлы, идентифицированные агентом
2. Постройте детальное понимание контекста
3. Только затем переходите к следующей фазе
```

### 4. Code Architect (Архитектор кода)

**Назначение:** Проектирование архитектурных решений

**Подходы к проектированию:**
- **Минимальные изменения** — наименьшие изменения, максимальное переиспользование
- **Чистая архитектура** — поддерживаемость, элегантные абстракции
- **Прагматичный баланс** — скорость + качество

**Процесс:**
```bash
# Фаза 4 в feature-dev workflow:
1. Запуск 2-3 архитекторов параллельно с разными фокусами
2. Обзор всех подходов
3. Формирование мнения (учитывая: размер задачи, срочность, сложность)
4. Презентация пользователю с рекомендациями
5. Ожидание выбора пользователя
```

### 5. Code Reviewer (Ревьюер кода)

**Назначение:** Проверка качества кода

**Критерии проверки:**
- Соответствие CLAUDE.md guidelines
- Очевидные баги в изменениях
- Контекстные проблемы через git blame/history

**Система оценки:**
- 0-25: Вероятно ложное срабатывание
- 26-50: Незначительное замечание
- 51-75: Валидная проблема низкого приоритета
- 76-90: Важная проблема требующая внимания
- **91-100: Критический баг или явное нарушение**

**Фильтрация:**
```markdown
Отфильтровываются проблемы с уверенностью < 80%
Игнорируются:
- Предыдущие проблемы, не введенные в PR
- Код, похожий на баг, но корректный
- Педантичные придирки
- Проблемы, которые поймает линтер
- Общие вопросы качества (если не в CLAUDE.md)
```

### 6. Silent Failure Hunter (Охотник за тихими ошибками)

**Назначение:** Поиск проблем с обработкой ошибок

**Фокус на:**
- Тихие падения без логирования
- Широкие catch-блоки
- Недостаточные сообщения об ошибках
- Неоправданные fallback'и
- Скрытые ошибки в пользовательском опыте

**Критерии качества:**
```python
# Проверка качества логирования:
- Логируется ли ошибка с правильной severity?
- Включен ли достаточный контекст?
- Есть ли error ID для Sentry tracking?
- Поможет ли лог при отладке через 6 месяцев?

# Проверка обратной связи пользователю:
- Получает ли пользователь четкую информацию?
- Объясняется ли что пошло не так?
- Указаны ли действия для решения?
- Достаточно ли специфично сообщение?
```

### 7. PR Test Analyzer (Анализатор тестов)

**Назначение:** Проверка покрытия тестами

**Анализ:**
- Покрытие edge cases
- Качество тестовых сценариев
- Полнота тестирования изменений

### 8. Comment Analyzer (Анализатор комментариев)

**Назначение:** Проверка качества документации

**Проверяет:**
- Точность комментариев
- Соответствие коду
- Полноту документации

### 9. Code Simplifier (Упроститель кода)

**Назначение:** Полировка и упрощение кода

**Применяется на:**
- Финальной стадии перед PR
- После прохождения всех проверок
- Для повышения читаемости

## Параллельное выполнение

### Концепция

Claude может запускать несколько субагентов одновременно для ускорения работы:

```bash
# Пример параллельного запуска:
# 4 агента одновременно проверяют разные аспекты

Agent #1: CLAUDE.md compliance
Agent #2: CLAUDE.md compliance (другая перспектива)
Agent #3: Obvious bugs scan
Agent #4: Git history context analysis

# Все результаты собираются и агрегируются
```

### Преимущества

1. **Скорость** — задачи выполняются одновременно
2. **Разнообразие перспектив** — разные углы анализа
3. **Эффективность** — параллельная работа с разными частями кода
4. **Качество** — независимые проверки снижают пропуск проблем

## Управление субагентами

### Возобновление работы

Claude может выбрать возобновление работы субагентов для:
- Дополнительного анализа
- Уточнения результатов
- Проверки новых гипотез

### Выбор модели

Для каждого субагента динамически выбирается модель:
- **Sonnet 4.5** — для сложного анализа и планирования
- **Opus 4** — для критических архитектурных решений
- **Haiku 4.5** — для быстрых проверок и исследования

### Доступ к инструментам

Субагенты имеют:
- Доступ к MCP tools
- Возможность указать `disallowedTools`
- Ограничения на основе permissions

## Workflow-примеры

### Feature Development (7 фаз)

```markdown
Фаза 1: Понимание требований
- Анализ задачи
- Уточняющие вопросы

Фаза 2: Исследование кодовой базы
- Запуск code-explorer агентов
- Чтение идентифицированных файлов
- Презентация находок

Фаза 3: Уточняющие вопросы
- Идентификация неясных аспектов
- Ожидание ответов пользователя

Фаза 4: Проектирование архитектуры
- Запуск 2-3 code-architect агентов
- Сравнение подходов
- Рекомендация с обоснованием
- Выбор пользователя

Фаза 5: Реализация
- Написание кода
- Следование выбранной архитектуре

Фаза 6: Code Review
- Запуск review-агентов
- Исправление проблем

Фаза 7: Финализация
- Полировка кода
- Создание PR
```

### PR Review Workflow

```bash
# Рекомендуемый порядок:
1. Написание кода → code-reviewer
2. Исправление проблем → silent-failure-hunter (для error handling)
3. Добавление тестов → pr-test-analyzer
4. Документирование → comment-analyzer
5. Прохождение проверок → code-simplifier (полировка)
6. Создание PR
```

## Best Practices

### 1. Читайте результаты агентов

```markdown
❌ НЕ ПРАВИЛЬНО:
Запустить агентов → сразу начать писать код

✅ ПРАВИЛЬНО:
Запустить агентов → прочитать идентифицированные файлы → 
построить понимание → затем действовать
```

### 2. Задавайте уточняющие вопросы рано

```markdown
Оптимальный момент: 
После понимания кодовой базы, ДО проектирования архитектуры

Идентифицируйте:
- Edge cases
- Обработка ошибок
- Точки интеграции
- Границы scope
- Предпочтения в дизайне
- Обратная совместимость
- Требования к производительности
```

### 3. Используйте TodoWrite

Отслеживайте прогресс через все фазы:
```bash
# Claude автоматически обновляет todo list
# Прозрачность выполнения
# Контроль за процессом
```

### 4. Доверяйте уверенности агентов

```markdown
Порог 80+ для code review — это:
- Уже фильтрует большинство ложных срабатываний
- Сбалансированный уровень доверия
- Проверенный на практике
```

### 5. Используйте полный workflow для сложных фич

7 фаз feature-dev обеспечивают:
- Тщательное планирование
- Глубокое понимание
- Качественную архитектуру
- Минимум переделок

## Создание кастомных агентов

### Структура агента

Кастомные агенты определяются в `.md` файлах:

```markdown
# Agent Name

## Your Role
Определение роли и ответственности агента

## Your Focus
Конкретные задачи и области внимания

## Your Tone
Стиль коммуникации

## Your Output Format
Формат результатов

## What NOT to Focus On
Что игнорировать
```

### Пример: Agent SDK Verifier

```markdown
## Verification Focus
- SDK installation and version
- Correct SDK usage patterns
- Agent initialization
- Environment and security
- Error handling
- Documentation

## What NOT to Focus On
- General code style (PEP 8, naming)
- Import ordering
- Python best practices не связанные с SDK
```

### Размещение агентов

```bash
# В плагинах:
/plugins/your-plugin/agents/your-agent.md

# Агенты доступны через:
/plugin install your-plugin
```

## Интеграция с MCP

Субагенты имеют доступ к MCP servers:
- Могут вызывать MCP tools
- Соблюдают permissions
- Работают с OAuth-аутентификацией
- Используют configured servers

```json
{
  "mcpServers": {
    "github": {
      "command": "npx",
      "args": ["-y", "@anthropic-ai/mcp-server-github"]
    }
  }
}
```

## Отладка субагентов

### Просмотр работы

```bash
# Включить режим мышления (Tab key)
# Показывает:
- Какие субагенты запускаются
- Их задачи и результаты
- Процесс принятия решений
```

### Логирование

```bash
# Debug режим
claude --debug

# Просмотр логов
tail -f ~/.claude/debug.log
```

## Заключение

Субагенты — это мощный механизм, который:
- Повышает качество работы через специализацию
- Ускоряет выполнение через параллелизм
- Обеспечивает глубину анализа
- Масштабируется для сложных задач
- Настраивается под специфические нужды

Правильное использование субагентов превращает Claude Code в команду специалистов, работающих над вашей задачей одновременно.

## Дополнительные ресурсы

- [Official Plugins](/plugins/) — примеры использования агентов
- [Feature Development Plugin](/plugins/feature-dev/) — 7-фазный workflow
- [PR Review Toolkit](/plugins/pr-review-toolkit/) — 6 специализированных агентов
- [Agent SDK Documentation](https://docs.anthropic.com/agent-sdk) — создание собственных агентов
